### 1.技术相关

#### 1.1 计算时间差

我们可以通过如下代码计算两个时间的时间差，并通过可读性高的方式输出：

```java
package com.test;

import cn.hutool.core.date.BetweenFormatter;
import cn.hutool.core.date.DateTime;
import cn.hutool.core.date.DateUtil;
import java.util.Date;

public class defaultTest {
    public static void main(String[] args) {
        DateTime parse = DateUtil.parse("2022-05-19 12:15:26");
        String endTime = DateUtil.formatBetween(parse.toJdkDate(), new Date(), BetweenFormatter.Level.SECOND);
        System.out.println("时间差：" + endTime);
    }
}
```

运行以上代码后，输出结果如下所示：

```properties
时间差：2小时24分50秒
```

> **说明**：可以通过这种方式计算运行时间，比如我们创建了一个容器，希望在前台展示这个容器的运行时间，就可以通过以上代码计算出当前时间和容器创建时间的差值得到运行时间。

### 2.踩坑相关

#### 2.1 Mybatis的NumberFormatException

今天在写mybatis的动态sql时报了一个NumberFormatException异常，涉及到的sql内容如下：

```sql
<if test="(scbs =='Y') and (cdbs == null || cdbs == '')">
    and exists (select 1 from pt_zbgl_favorite fav where
    fav.lx='BASE.MX' and fav.dm = mx.mx_dm and fav.yxbz='Y')
</if>
```

异常信息如下所示：

```xml
### Error querying database.  Cause: java.lang.NumberFormatException: For input string: "Y"
### Cause: java.lang.NumberFormatException: For input string: "Y"
	at org.apache.ibatis.exceptions.ExceptionFactory.wrapException(ExceptionFactory.java:30)
	at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:150)
	at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:141)
	at sun.reflect.GeneratedMethodAccessor455.invoke(Unknown Source)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:433)
	... 90 common frames omitted
```

这个报错的主要原因是，Mybatis的OGNL语法把'Y'认为成了char类型，而scbs字段我们代码设置的是String类型。解决办法就是不要在动态sql中使用`'Y'`，而是使用`"Y"`，然后外层使用单引号即可，如下所示：

```sql
<if test='(scbs =="Y") and (cdbs == null || cdbs == "")'>
```

#### 2.2 使用group_concat函数的类型问题

在mysql数据库中，group_concat函数可以实现将多个值通过指定分隔符拼接成字符串返回。在使用mybatis时，可以在写sql语句时使用该函数将相关数据拼接成字符串，然后封装到java对象的字符串字段中。下面先说下该函数的一些主要用法，然后再说踩的坑。

group_concat函数的完整语法如下：

```sql
group_concat([DISTINCT] 要连接的字段 [Order BY 排序字段 ASC/DESC] [Separator '分隔符'])
```

下面演示一下该函数的效果，准备的数据如下所示：

```sql
mysql> select * from student;
+----+-------+------+
| id | name  | age  |
+----+-------+------+
|  1 | Tom   |   18 |
|  2 | Mark  |   25 |
|  3 | Lucy  |   22 |
|  4 | Jerry |   25 |
+----+-------+------+
4 rows in set (0.00 sec)
```

使用group_concat(name)将符合条件的数据的name字段拼接成字符串，如下所示：

```sql
mysql> select group_concat(name) from student;
+---------------------+
| group_concat(name)  |
+---------------------+
| Tom,Mark,Lucy,Jerry |
+---------------------+
1 row in set (0.00 sec)
```

默认的分隔符是逗号，我们也可以手动指定分隔符，比如使用分号，如下所示：

```sql
mysql> select group_concat(name separator ';') from student;
+----------------------------------+
| group_concat(name separator ';') |
+----------------------------------+
| Tom;Mark;Lucy;Jerry              |
+----------------------------------+
1 row in set (0.00 sec)
```

我们也可以在拼接的时候进行去重操作，如下所示：

```sql
# 这个是去重前的效果
mysql> select group_concat(age) from student;
+-------------------+
| group_concat(age) |
+-------------------+
| 18,25,22,25       |
+-------------------+
1 row in set (0.00 sec)

# 这个是去重后的效果
mysql> select group_concat(distinct age) from student;
+----------------------------+
| group_concat(distinct age) |
+----------------------------+
| 18,25,22                   |
+----------------------------+
1 row in set (0.00 sec)
```

我们甚至可以进行排序，这里以倒序为例，如下所示：

```sql
# order by后面也可以是别的字段，并不是group_concat后面是什么字段，排序就要用什么字段
mysql> select group_concat(age order by age desc) from student;
+-------------------------------------+
| group_concat(age order by age desc) |
+-------------------------------------+
| 25,25,22,18                         |
+-------------------------------------+
1 row in set (0.00 sec)
```

最后来个组合效果，如下所示：

```sql
mysql> select group_concat(distinct age order by age desc separator ';') from student;
+------------------------------------------------------------+
| group_concat(distinct age order by age desc separator ';') |
+------------------------------------------------------------+
| 25;22;18                                                   |
+------------------------------------------------------------+
1 row in set (0.00 sec)
```

用法说完了，下面就说踩坑的地方了。首先group_concat函数拼接后的字符串是有长度限制的，而且使用这个函数返回的结果并不一定都是字符串。如果在mybatis的xml配置中写sql的时候使用这个函数，那需要注意对应的Mapper方法的返回值是什么，假设是一个Map集合。由于我们使用group_concat函数的时候，sql中一般都会设置别名，所以这个别名就是集合中的key值，group_concat函数的结果就是集合中的value值。

上面说了，group_concat函数返回的值并不一定都是字符串类型，如果不知道这个坑，那么当我们从Map中取值的时候就有可能出现问题。我遇到的问题是，group_concat函数返回的结果是一个byte[]数组，然后这个数组就存入到了Map集合的value中了。

如果我们总是希望group_concat函数返回的结果就是字符串类型，那可以使用`convert函数`或者`cast函数`去解决这个问题，将group_concat函数的结果转成字符串类型后再进行返回，比如下面这样：

```sql
mysql> select convert(group_concat(name),char) as result from student;
+---------------------+
| result              |
+---------------------+
| Tom,Mark,Lucy,Jerry |
+---------------------+
1 row in set (0.00 sec)

mysql> select cast(group_concat(name) as char) as result from student;
+---------------------+
| result              |
+---------------------+
| Tom,Mark,Lucy,Jerry |
+---------------------+
1 row in set (0.00 sec)
```

> **说明**：使用`convert函数`或者`cast函数`都是可以的，效果都是一样的，它们也没啥大的区别，只是语法不同而已。



































































