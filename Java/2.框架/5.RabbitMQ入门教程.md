### 1.初识MQ

#### 1.1 同步和异步通讯

##### 1.1.1 同步通讯的优缺点

同步方式虽然调用可以实时得到结果，但却存在下面的问题：

![image-20211119223715893](https://cdn.jsdelivr.net/gh/gongcqq/FigureBed@main/Image/Typora/20211119230426.png) 

**同步调用的优点：**

- 时效性较强，可以立即得到结果。

**同步调用的缺点：**

- 耦合度高；
- 性能和吞吐能力下降；
- 有额外的资源消耗；
- 有级联失败问题。

##### 1.1.2 异步通讯的优缺点

异步调用常见实现就是事件驱动模式，以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，需要调用物流服务，从仓库分配响应的库存并准备发货，以及调用短信服务通知支付结果。如下所示：

![image-20211119225121579](https://cdn.jsdelivr.net/gh/gongcqq/FigureBed@main/Image/Typora/20211119230435.png) 

在事件模式中，支付服务是事件`发布者`(publisher)，在支付完成后只需要发布一个支付成功的`事件`(event)，事件中带上订单id。订单服务、物流服务以及短信服务都是事件`订阅者`(Consumer)，订阅支付成功的事件，监听到事件后完成自己业务即可。

为了解除事件发布者与订阅者之间的耦合，两者并不是直接通信，而是通过起到中间人角色的Broker。发布者发布事件到Broker，不关心谁来订阅事件。订阅者从Broker订阅事件，不关心谁发来的消息。

![image-20211119225730288](https://cdn.jsdelivr.net/gh/gongcqq/FigureBed@main/Image/Typora/20211119230442.png) 

Broker是一个像数据总线一样的东西，所有的服务要接收数据和发送数据都发到这个总线上，这个总线就像协议一样，让服务间的通讯变得标准和可控。

**异步调用的优点：**

- `吞吐量提升`：无需等待订阅者处理完成，响应更快速；
- `故障隔离`：服务没有直接调用，不存在级联失败问题；
- `调用无阻塞`：调用间没有阻塞，不会造成无效的资源占用；
- `低耦合`：耦合度极低，每个服务都可以灵活插拔，可替换；
- `流量削峰`：不管发布事件的流量波动多大，都由Broker接收，订阅者可以按照自己的速度去处理事件。

**异步调用的缺点：**

- 架构复杂了，业务没有明显的流程线，不好管理；
- 需要依赖于Broker的可靠性、安全性以及性能。

> **说明**：开源软件或云平台上Broker的软件是非常成熟的，比较常见的一种就是我们今天要学习的MQ技术。

#### 1.2 常见的MQ技术对比

MQ(MessageQueue)，中文是消息队列，字面来看就是存放消息的队列，也就是事件驱动架构中的Broker。

几种常见MQ的对比如下：

![image-20211119231325786](https://cdn.jsdelivr.net/gh/gongcqq/FigureBed@main/Image/Typora/20211119231821.png) 

结论如下：

- `追求可用性`：Kafka、RocketMQ、RabbitMQ
- `追求可靠性`：RabbitMQ、RocketMQ
- `追求吞吐能力`：RocketMQ、Kafka
- `追求消息低延迟`：RabbitMQ、Kafka

### 2.RabbitMQ入门

#### 2.1 RabbitMQ概述

[RabbitMQ](https://www.rabbitmq.com/)是基于Erlang语言开发的开源消息通信中间件，它的基本结构如下所示：

![image-20211119232135006](https://cdn.jsdelivr.net/gh/gongcqq/FigureBed@main/Image/Typora/20211119232543.png) 

RabbitMQ中的一些角色：

- `publisher`：生产者；
- `consumer`：消费者；
- `exchange`：交换机，负责消息路由；
- `queue`：队列，存储消息；
- `virtualHost`：虚拟主机，隔离不同租户的exchange、queue以及消息的隔离。

#### 2.2 RabbitMQ的安装

##### 2.2.1 普通方式安装

1. 首先我们从github上下载[rabbitmq安装包](https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.8.8/rabbitmq-server-3.8.8-1.el7.noarch.rpm)以及它依赖的[erlang环境包](https://github.com/rabbitmq/erlang-rpm/releases/download/v21.3.7/erlang-21.3.7-1.el7.x86_64.rpm)，如果网速不好，也可以使用以下备用下载地址进行下载：

   ```bash
   # 下载rabbitmq-server-3.8.8-1.el7.noarch.rpm
   https://gongsl.lanzoui.com/ioQACwoi41e
   
   # 下载erlang-21.3.7-1.el7.x86_64.rpm
   https://gongsl.lanzoui.com/igGtzwoi3yb
   ```

2. 将下载的包传到linux主机上后就可以进行安装了：

   ```bash
   # 首先安装一个erlang的依赖
   yum install -y socat
   
   # 然后使用rpm命令安装erlang环境
   rpm -ivh erlang-21.3.7-1.el7.x86_64.rpm
   
   # 最后安装rabbitmq
   rpm -ivh rabbitmq-server-3.8.8-1.el7.noarch.rpm
   ```

3. 下载完成之后，直接启动即可：

   ```bash
   systemctl start rabbitmq-server
   ```

4. rabbitmq启动成功之后，我们需要安装一个web管理插件，以便能够访问rabbitmq控制台：

   ```bash
   rabbitmq-plugins enable rabbitmq_management
   ```

   ![image-20211120005231454](https://cdn.jsdelivr.net/gh/gongcqq/FigureBed@main/Image/Typora/20211120011849.png) 

5. 然后需要添加一个用户，方便登录控制台：

   ```bash
   # 创建用户，用户名是admin，密码是123
   rabbitmqctl add_user admin 123
   
   # 设置用户角色
   rabbitmqctl set_user_tags admin administrator
   
   # 设置用户在"/"这个虚拟主机下的所有权限
   rabbitmqctl set_permissions -p "/" admin ".*" ".*" ".*"
   
   # 然后我们也可以通过以下命令查看用户
   rabbitmqctl list_users
   ```

6. 最后使用创建好的用户名密码登录控制台即可，地址就是我们主机的地址，端口是`15672`，比如下面这样：

   ```http
   http://192.168.68.11:15672/
   ```

   ![image-20211120011600590](https://cdn.jsdelivr.net/gh/gongcqq/FigureBed@main/Image/Typora/20211120011854.png) 

##### 2.2.2 docker方式安装





































